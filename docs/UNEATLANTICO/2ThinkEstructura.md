# Estructura

## Ejemplo 1

<div align=center>

`253 x 25 + 15`

</div>

<table>
<tr><th>Procedimiento</th><th>Procedimiento</th></tr>
<tr><td>
Para resolver esta operación primero debo hacer la multiplicación porque tiene prioridad sobre la suma. Entonces tomo el doscientos cincuenta y tres y lo multiplico por veinticinco. Para ello, primero multiplico el tres por el cinco que me da quince, pongo el cinco y me llevo una. Luego multiplico el cinco por el cinco que da veinticinco, más la una que llevaba son veintiséis, pongo el seis y llevo dos. Después multiplico el dos por el cinco que da diez, más las dos que llevaba son doce. Eso me da mil doscientos sesenta y cinco. Pero como el cinco está en la posición de las unidades y ahora voy con el dos que está en las decenas, debo desplazar, así que bajo un cero. Ahora multiplico el tres por el dos que da seis, escribo el seis. Luego el cinco por el dos que da diez, escribo el cero y llevo una. Finalmente el dos por el dos que da cuatro, más la una que llevaba son cinco, escribo el cinco. Eso me da cinco mil sesenta. Ahora sumo mil doscientos sesenta y cinco más cinco mil sesenta que me da seis mil trescientos veinticinco. A eso le sumo quince: tres más cinco es ocho, dos más uno es tres y seis más cero es seis. El resultado es seis mil trescientos cuarenta.        
</td><td>

```
              
    253
  ×  25
  -----
  1265
  506
  -----
  6325

  6325
+   15
  ----
  6340
```
    
</td></tr>
</table>




## Ejemplo 2:

<table>
<tr><th>Instrucciones</th><th>Instrucciones</th></tr>
<tr><td>
Para ensamblar el armario PAX primero debe localizar todas las piezas que vienen en el paquete. Busque la pieza numerada 10042625 que es un panel lateral grande de color blanco, también necesitará otra pieza igual numerada 10046294 que es el otro panel lateral, y una tercera pieza 10046295 que es el panel superior. Además localice dos piezas 10042610, 10046296 y 10046297 que son los rieles horizontales internos. También necesitará dos conjuntos de piezas 10042543, 10046300 y 10046304 que forman los mecanismos de los rieles deslizantes.

Luego busque la pieza 10042526 que viene por duplicado y son los soportes de esquina metálicos, y dos piezas numeradas 10042612, 10046271 y 10046292 que es el panel inferior del armario. Localice también dos piezas 10046275 que son las piezas de fijación a la pared, dos piezas 100644 y dos 100402 que son los soportes de montaje, dos piezas 100823 que son las cubiertas decorativas de plástico, y la pieza 10094315 que es una barra metálica larga.

Ahora localice los elementos pequeños: cuatro tornillos 10108698, dos tornillos 101349, dos piezas 10046278 que son las escuadras de refuerzo, y dos piezas 10120505 que son los clips de fijación del panel trasero.

Una vez localizadas todas las piezas, comience el ensamblaje. Tome uno de los paneles laterales grandes (10042625) y colóquelo en el suelo en posición horizontal con el lado que tiene los agujeros pretaladrados hacia arriba. Ahora tome dos de las piezas 10120505 que son los clips y colóquelos en dos de los agujeros que están en el borde superior del panel lateral. Presione firmemente hasta que encajen con un clic audible.

Luego tome el otro panel lateral (10046294) y colóquelo también en posición horizontal en el suelo con los agujeros hacia arriba. Instale otros dos clips 10120505 de la misma manera que hizo con el primer panel, en los agujeros del borde que quedará en la parte superior.

Ahora tome las dos piezas de los soportes metálicos de esquina 10042526 y coloque uno en cada esquina superior de cada panel lateral. Los soportes tienen una forma de L y deben encajar en las ranuras que están en las esquinas de los paneles. Presione con firmeza hasta que asienten completamente en las ranuras.

A continuación tome el panel superior 10046295 y con ayuda de otra persona (es muy importante tener ayuda en este paso) levante ambos paneles laterales para ponerlos en posición vertical sosteniendo cada uno un panel. Mientras mantienen los paneles verticales, deslice el panel superior entre los dos paneles laterales de manera que las lengüetas del panel superior entren en las ranuras de los soportes metálicos que instaló previamente. Este paso requiere algo de fuerza y precisión. Una vez que el panel superior esté en su lugar, debe escuchar o sentir como encaja.

Ahora con los paneles laterales aún en posición vertical y unidos por el panel superior, tome una de las dos piezas del conjunto del panel inferior (10042612) y deslícela en las ranuras inferiores de los paneles laterales. La pieza debe entrar suavemente en las guías que están en la parte interior inferior de cada panel lateral. Una vez colocada la primera pieza del panel inferior, tome la segunda pieza (10046271) y deslícela de la misma manera asegurándose de que quede alineada y nivelada con la primera pieza.

En este punto debe tener una estructura básica de armario con dos laterales, un panel superior y un panel inferior de dos piezas. Ahora procederemos a instalar los rieles internos. Tome uno de los conjuntos de tres piezas que forman el riel (10042610, 10046296 y 10046297). Estos rieles se instalan en el interior del armario y sirven para montar los elementos deslizantes posteriormente. Para instalarlos, localice los agujeros que están en la parte interior de cada panel lateral aproximadamente a un tercio de la altura desde abajo. Enganche el extremo del riel en el agujero del panel lateral derecho y luego extienda el riel hacia el panel lateral izquierdo asegurándose de que el otro extremo enganche en el agujero correspondiente del lado izquierdo. Repita esta operación con el segundo conjunto de rieles instalándolo aproximadamente a dos tercios de la altura del armario. Es importante que ambos rieles queden perfectamente horizontales y paralelos entre sí.

Ahora tome los cuatro tornillos largos tipo 10108698 y usando un destornillador Phillips número 2, atornille dos tornillos en cada una de las esquinas superiores donde se unen el panel superior con los paneles laterales, insertando los tornillos a través de los agujeros que se alinean en estas juntas. Apriete firmemente pero sin forzar excesivamente para no dañar las piezas.

A continuación tome las dos escuadras de refuerzo metálicas numeradas 10046278. Estas escuadras se instalan en las esquinas inferiores traseras del armario para darle mayor estabilidad. Coloque una escuadra en cada esquina de manera que los agujeros de la escuadra se alineen con los agujeros pretaladrados en los paneles laterales y en el panel inferior. Use dos de los tornillos 101349 para fijar cada escuadra atornillándolos a través de los agujeros. Apriete firmemente.

Ahora tome las dos piezas 10046275 que son los dispositivos de fijación a la pared. Estas piezas son cruciales para la seguridad y deben instalarse según las advertencias de seguridad del manual. Cada pieza tiene forma de L metálica con agujeros. Coloque una pieza en la parte superior de cada panel lateral en la cara interior del panel, de modo que la parte vertical de la L quede contra el panel lateral y la parte horizontal se extienda hacia atrás. Fije cada pieza usando los agujeros pretaladrados en los paneles laterales.

Después tome las dos cubiertas decorativas de plástico blanco numeradas 100823 y colóquelas presionando sobre los soportes metálicos que instaló en las esquinas superiores al inicio del ensamblaje. Estas cubiertas simplemente se presionan y encajan para cubrir los mecanismos metálicos y dar un acabado limpio.

Ahora debe instalar los componentes del sistema de rieles deslizantes. Tome uno de los conjuntos de tres piezas (10042543, 10046300, 10046304) que forman el mecanismo deslizante completo. Este conjunto debe ensamblarse primero antes de instalarlo en los rieles que ya colocó en el interior del armario. Las tres piezas encajan entre sí formando un riel telescópico. Deslice la pieza más pequeña dentro de la pieza mediana, y la pieza mediana dentro de la pieza más grande, de manera que puedan extenderse y retraerse suavemente. Una vez ensamblado este mecanismo, engánchelo en uno de los rieles horizontales que instaló anteriormente en el interior del armario. El mecanismo tiene unos ganchos en sus extremos que se encajan en el riel horizontal. Asegúrese de que el mecanismo se deslice suavemente de adelante hacia atrás a lo largo del riel. Repita este proceso con el segundo conjunto de piezas deslizantes instalándolo en el segundo riel horizontal.

En este punto tome la barra metálica larga numerada 10094315. Esta barra se instala horizontalmente en la parte superior interior del armario y sirve para colgar perchas de ropa. Para instalarla, localice los soportes circulares que están en la parte superior interna de cada panel lateral. Inserte un extremo de la barra en el soporte de un lado y luego comprima ligeramente la barra para poder insertar el otro extremo en el soporte del lado opuesto. Una vez que ambos extremos estén en sus soportes, la barra debe quedar firmemente en su lugar sostenida por la tensión.

Finalmente tome los dos soportes numerados 100644 y 100402. Estos soportes se instalan en la parte trasera superior del armario y sirven para fijar el panel posterior que proporcionará estabilidad adicional. Coloque cada soporte en las esquinas superiores traseras del armario, de modo que queden preparados para recibir el panel posterior. El panel posterior (que no viene incluido en este conjunto) deberá clavarse posteriormente a estos soportes usando pequeñas puntillas.

Para completar el montaje, el armario debe fijarse a la pared usando los dispositivos 10046275 que ya instaló. Coloque el armario en su posición final contra la pared. Marque en la pared la posición de los agujeros de los dispositivos de fijación. Retire temporalmente el armario, taladre agujeros en la pared en las posiciones marcadas e inserte tacos adecuados para su tipo de pared. Vuelva a colocar el armario contra la pared y atornille los dispositivos de fijación a los tacos de la pared usando tornillos adecuados (no incluidos). Los tornillos deben tener un diámetro de 5 milímetros y ser lo suficientemente largos para atravesar el dispositivo de fijación y anclarse firmemente en el taco de la pared. Apriete los tornillos firmemente para asegurar que el armario no pueda volcarse.
</td>
<td align=center valign=top> <a href="https://www.ikea.com/es/en/assembly_instructions/pax-wardrobe-frame-white__AA-2496555-2-2.pdf#page=9">Manual</a></td></tr>
</table>

## Ejemplo 3

<table>
<tr><td width=50%><img src="https://github.com/user-attachments/assets/fc411636-ba73-485d-8b37-baf11b0da720"></td><td width=50% align=center valign=top><img src="https://github.com/user-attachments/assets/f3836189-6d6c-498b-a160-02bbc5d6ef89"></td></tr>
</table>

## Ejemplo 4

<img src="https://private-user-images.githubusercontent.com/8528047/539661404-a9394f03-3bc9-4c2c-aac6-7439a953f33b.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3Njk1ODkzMDYsIm5iZiI6MTc2OTU4OTAwNiwicGF0aCI6Ii84NTI4MDQ3LzUzOTY2MTQwNC1hOTM5NGYwMy0zYmM5LTRjMmMtYWFjNi03NDM5YTk1M2YzM2IucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI2MDEyOCUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNjAxMjhUMDgzMDA2WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NTg4Nzc1OGRkZWY2ZDRiOThkOTU1OGI3YjQ4MDI5YzIxMTllZTkzOGI2MjQ1NDE0ODBiNzM5NmU0OGVhNzM1MCZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.Q3lQ-ShyYb9wa9av4nXI7zDxYUOH4nE1GGUY74s0B14">

<table>
<tr><th>Respuesta</th><th>Respuesta</th></tr>
<tr><td valign=top>

Para resolver el problema del sistema de conversación con LLM, propongo utilizar una estructura de datos que comienza con una entidad llamada UnUsuario que representa al usuario del sistema. Esta entidad UnUsuario contiene una relación de composición con una entidad llamada Conversacion, lo que significa que cada usuario tiene una conversación asociada y cuando el usuario se elimina, la conversación también se elimina.

La entidad Conversacion a su vez contiene dentro de ella otra estructura llamada VentanaDeContexto. Esta VentanaDeContexto es la encargada de gestionar la ventana de contexto del sistema y mantiene información sobre la cantidad de tokens, que se almacena en un atributo llamado tokensSize de tipo entero. La VentanaDeContexto contiene dentro de ella una estructura llamada ContextoActivo.

El ContextoActivo es donde se mantiene la estructura principal de la conversación que está actualmente activa. Esta estructura ContextoActivo contiene un árbol de mensajes. Este árbol está compuesto por nodos que pueden ser de dos tipos: Pregunta o Respuesta. Estos nodos se organizan de manera jerárquica formando una estructura de árbol.

La estructura funciona de la siguiente manera: hay un primer nodo que es una Pregunta, y esta Pregunta puede tener una o varias respuestas conectadas a ella. En el diagrama se puede ver que desde la Pregunta inicial salen conexiones hacia varios nodos de tipo Respuesta. Específicamente, desde la primera Pregunta hay tres flechas que apuntan a tres Respuestas diferentes, lo que representa las múltiples respuestas posibles que puede generar el asistente para una misma pregunta, ya sea porque se regeneró la respuesta o porque hay diferentes versiones.

Cada uno de estos nodos Respuesta puede a su vez conectar con otro nodo Pregunta. Por ejemplo, la primera Respuesta conecta con una Pregunta subsiguiente, y esta Pregunta subsiguiente conecta con otra Respuesta. Esta segunda Respuesta no tiene más conexiones salientes, indicando que es un nodo terminal en esa rama del árbol.

La segunda Respuesta (hermana de la primera) también conecta con una Pregunta, y esta Pregunta tiene dos Respuestas saliendo de ella. Esto muestra cómo el árbol puede tener múltiples ramificaciones en diferentes niveles. Una de estas dos Respuestas no tiene más conexiones, siendo un nodo terminal, mientras que la otra conecta con una Pregunta adicional, que a su vez conecta con una Respuesta final.

La tercera Respuesta del nivel inicial también tiene una Pregunta conectada, y esta Pregunta tiene dos Respuestas. Una de estas Respuestas es terminal, pero la otra conecta con una Pregunta que finalmente conecta con una última Respuesta que también es terminal.

En cuanto a la estructura de datos de los nodos individuales, tanto Pregunta como Respuesta son tipos de una entidad más general llamada Elemento. La entidad Elemento tiene una relación de composición con tres componentes: puede contener Texto, puede contener Imágenes, y puede contener Documentos. Estos tres componentes (Texto, Imágenes y Documentos) son los que conforman el contenido de cada mensaje.

Además existe una entidad llamada Detalles que contiene información adicional sobre los elementos. Esta entidad Detalles tiene dos atributos: uno llamado descripción que es de tipo String y almacena una descripción textual, y otro llamado tokensSize que es de tipo entero y almacena el número de tokens que ocupa ese elemento.

Es importante mencionar que en el margen del diseño también se indica la existencia de otras conversaciones. Hay una referencia a OtraConversacion y otra a OtraConversacionMas, lo que sugiere que el usuario puede tener múltiples conversaciones simultáneas, aunque el diagrama se centra en mostrar la estructura de una conversación individual en detalle.

Las conexiones entre los nodos del árbol representan la secuencia de la conversación, donde cada Pregunta del usuario puede tener múltiples Respuestas del asistente (por regeneración o por edición), y cada Respuesta puede llevar a una nueva Pregunta del usuario, creando así una estructura de árbol donde cada camino desde la raíz hasta una hoja representa una posible secuencia de intercambios entre usuario y asistente.

La estructura permite navegar entre las diferentes respuestas disponibles  para una misma pregunta, lo que corresponde a la funcionalidad de regenerar  respuestas o de ver versiones alternativas. También permite que al editar  una pregunta anterior se cree una nueva rama del árbol, manteniendo las  ramas anteriores intactas pero creando una nueva secuencia de conversación  desde el punto de edición.

La VentanaDeContexto que envuelve todo el ContextoActivo es la responsable  de gestionar qué parte del árbol se incluye en el contexto cuando se genera  una nueva respuesta, limitándose por el tokensSize disponible y seleccionando  los mensajes relevantes del árbol para construir el contexto completo de la  conversación activa.

</td>
<td valign=top> 

Para resolver el problema propongo hacer lo siguiente. Primero tenemos 
que tener algo que represente al usuario, entonces creamos una cosa que 
llamaremos Usuario y esta cosa va a tener dentro otra cosa que es la 
Conversación. La conversación está dentro del usuario porque el usuario 
es quien tiene la conversación.

Dentro de la conversación ponemos otra cosa que es como una ventana donde 
se ve el contexto. Esta ventana tiene que saber cuántos tokens hay, entonces 
le ponemos un número que guarde eso. Dentro de esta ventana de contexto 
hay otra cosa que es el contexto que está activo en este momento.

Ahora viene la parte importante. El contexto activo tiene que guardar los 
mensajes, pero no es solo una lista de mensajes uno detrás de otro, sino 
que los mensajes se conectan entre ellos de una manera especial. Lo que 
pasa es que cuando el usuario hace una pregunta, el sistema puede dar 
varias respuestas diferentes para esa misma pregunta. Por ejemplo, si 
regeneras la respuesta, entonces tienes la pregunta original pero con 
dos o tres respuestas distintas.

Entonces lo que hacemos es que cada pregunta puede apuntar a varias 
respuestas. En mi diseño muestro que desde una pregunta salen líneas 
hacia tres respuestas diferentes. Cada una de esas respuestas representa 
una versión diferente de lo que el sistema podría contestar.

Pero no solo eso, sino que cada respuesta también puede tener después 
otra pregunta del usuario. O sea que después de que el sistema responde, 
el usuario puede hacer otra pregunta, y esa pregunta puede tener a su 
vez otras respuestas. Es como que va creciendo hacia abajo y hacia los 
lados al mismo tiempo.

Por ejemplo, si miras la primera respuesta que sale de la pregunta inicial, 
esa respuesta se conecta con otra pregunta que viene después, y esa segunda 
pregunta se conecta con otra respuesta. Esa respuesta final ahí se queda, 
no tiene nada más después.

Luego si miras la segunda respuesta que sale de la pregunta inicial, esa 
también se conecta con una pregunta que viene después, pero esa pregunta 
tiene DOS respuestas saliendo de ella. O sea que ahí se divide en dos 
caminos. Una de esas dos respuestas se queda ahí sin nada más, pero la 
otra sí tiene otra pregunta después, y esa pregunta tiene una respuesta 
al final.

Y lo mismo pasa con la tercera respuesta de la pregunta inicial. Esa también 
tiene una pregunta conectada, y esa pregunta tiene dos respuestas. Una se 
queda ahí terminada, pero la otra sigue con otra pregunta y otra respuesta 
al final.

Todo esto forma como una estructura que se va ramificando, donde desde un 
punto inicial vas teniendo más y más caminos posibles. Es como cuando en 
un camino llegas a una bifurcación y puedes ir por la derecha o por la 
izquierda, y luego en cada uno de esos caminos puede haber más bifurcaciones.

Ahora, cada una de estas cosas que representan preguntas o respuestas tiene 
que guardar información. Entonces lo que hago es que todas ellas, tanto las 
preguntas como las respuestas, son del mismo tipo de cosa base que llamamos 
Elemento. Este Elemento puede tener diferentes partes adentro: puede tener 
texto, puede tener imágenes, y puede tener documentos. Entonces cuando el 
usuario envía algo o cuando el sistema responde, ese algo puede ser texto 
solo, o puede ser texto con una imagen, o con un documento, o cualquier 
combinación de esos tres tipos de contenido.

También necesitamos guardar algunos detalles adicionales sobre cada cosa. 
Estos detalles incluyen una descripción que es texto que explica qué es, 
y también el tamaño en tokens que ocupa esa cosa. Esto es importante porque 
el sistema tiene un límite de cuántos tokens puede manejar a la vez, entonces 
necesitamos ir sumando cuántos tokens tiene cada pedazo para saber si todavía 
cabe más o no.

Una cosa que también aparece en el diseño, aunque no está conectada directamente 
con todo lo anterior, es que puede haber otras conversaciones. En el dibujo 
pongo al lado que puede haber OtraConversacion y otra más que se llama 
OtraConversacionMas. Esto representa que el usuario no solo tiene una 
conversación sino que puede tener varias conversaciones diferentes al mismo 
tiempo, cada una con su propia estructura ramificada de preguntas y respuestas.

La forma en que esto funciona para permitir las operaciones que necesitamos 
es la siguiente: cuando el usuario quiere regenerar una respuesta, lo que 
pasa es que desde la pregunta que ya existe se crea una nueva línea hacia 
una respuesta nueva, pero las respuestas anteriores siguen estando ahí. 
Entonces la pregunta queda conectada a todas las respuestas, y puedes moverte 
entre ellas usando las flechitas que ves en la interfaz.

Cuando el usuario edita una pregunta anterior, lo que sucede es que desde 
ese punto se crea una nueva rama. La pregunta editada genera una respuesta 
nueva, y desde ahí puede seguir creciendo la conversación, pero todo lo que 
había después de la pregunta original en la otra rama sigue existiendo, 
simplemente ahora tienes dos caminos diferentes desde ese punto.

Para recuperar el contexto completo cuando el sistema tiene que generar una 
nueva respuesta, lo que se hace es seguir las conexiones hacia atrás desde 
donde estás hasta llegar al principio de la conversación. Vas subiendo por 
las conexiones y vas recolectando todos los mensajes que encuentras en ese 
camino. Esos son los mensajes que forman el contexto activo que se le pasa 
al sistema para que genere la siguiente respuesta.

La ventana de contexto que envuelve todo esto es la que se encarga de controlar 
que no nos pasemos del límite de tokens. Va contando cuántos tokens suman 
todos los mensajes del camino activo, y si llega al límite, entonces empieza 
a descartar los mensajes más antiguos para que quepan los más recientes sin 
pasarse del máximo permitido.

</td></tr>
</table>
